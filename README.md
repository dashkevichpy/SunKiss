# SunKiss Nutrient Controller

Аппаратная платформа для управления раствором гидропоники на базе Arduino Nano.

## Аппаратная спецификация

- **MCU:** Arduino Nano (ATmega328P, 5 V, 16 MHz, 10-бит АЦП).
- **Дисплей:** LCD 16×2 с I²C (PCF8574), адрес 0x3F (фолбек 0x27).
- **Датчики:**
  - Gravity Analog TDS → A0.
  - PH-4502C / Gravity Analog pH → A1.
  - Резерв под датчики уровня → A2, A3.
  - Температура раствора → DS18B20 (в планах, D4).
- **Насосы:**
  - Два насоса перемешивания 220 В AC (через SSR) → D5, D6.
  - Перистальтические 12 В DC: pH-DOWN (D7), pH-UP (D8), удобрение A (D9), удобрение B (D10) через MOSFET-драйверы.
- **Коммуникации:** Управление и обмен данными через Serial/ПК, кнопок нет.
- **Питание:** Силовая часть насосов питается от отдельного 12 В БП, 220 В цепи разделены SSR.

## Конфигурация пинов

См. `include/pins.h` для единого определения всех пинов и логики активного уровня реле (`RELAY_ACTIVE_LOW`).

## Драйверы исполнительных механизмов

Модуль `drivers/Actuators.*` предоставляет функции включения/выключения насосов и отключения всех исполнительных устройств.

## Датчики и сглаживание

Модуль `sensors/Sensors.*` реализует неблокирующий опрос АЦП каждые 100 мс с медианным фильтром по 5 значениям и экспоненциальным EMA (α=0.2). Каждые 500 мс обновляются усреднённые показания pH и EC/TDS. Реальное питание измеряется через `readVcc_mV()` с использованием внутренней опоры 1.1 V.

### Калибровка pH

Команды по Serial:

- `CAL_PH START` — перейти в режим калибровки (очищает временные точки).
- `CAL_PH POINT <4.01|6.86|9.18>` — зафиксировать текущие усреднённые напряжения буферов.
- `CAL_PH SAVE` — рассчитать коэффициенты по методу наименьших квадратов, сохранить в EEPROM.
- `CAL_PH ABORT` — выйти без сохранения.
- `CAL_PH READ` — вывести текущие коэффициенты и напряжения опорных буферов.

До первой калибровки используется безопасная линейная модель (по умолчанию a≈-5.70, b≈21.34) с предупреждением о необходимости калибровки.

### EC/TDS и температурная компенсация

- `SET_T <°C>` — задать температуру раствора (по умолчанию 25 °C; без команды на дисплее отображается `T:--`).
- `SET_EC_ALPHA <α>` — коэффициент температурной компенсации (умолчание 0.02).
- `SET_TDSFACTOR <500|640|700>` — выбор шкалы пересчёта в ppm (по умолчанию 500).
- `SET_K <float>` — ручная установка постоянной ячейки.
- `CAL_EC START/POINT/SAVE/ABORT/READ` — рабочий цикл подстройки `K` (используется нормализованное EC@25 °C, промежуточное значение хранится до `SAVE`).

Значения `alpha`, `tdsFactor` и `K` сохраняются в EEPROM. Показания EC нормализуются к 25 °C, а TDS рассчитывается на их основе.

## LCD 16×2

Модуль `ui/LcdPages.*` выводит три страницы, автоматически перелистываемые каждые 5 с без очистки экрана:

1. `pH` и компенсированный `EC` (мСм/см, 2 знака).
2. Температура раствора и измеренный `Vcc` (используется `T:--`, если температура не задана).
3. `TDS` (ppm) и текущие параметры ячейки (`K`, фактор ppm).

Обновляются только изменившиеся строки, чтобы избежать мерцания.

## Хранение настроек и EEPROM

Модуль `storage/Config.*` содержит структуру настроек контроллера (версия, CRC16) и отвечает за загрузку/сохранение в EEPROM. Сохраняются:

- Коэффициенты калибровки pH (a, b) и захваченные напряжения буферов 4.01/6.86/9.18.
- Параметры EC/TDS: `alpha`, `tdsFactor`, `K`.
- Расходы всех дозирующих помп (мл/с), активный уровень SSR (`relay_active_low`) и `deviceId`.
- Пороговые величины процесса, паузы, ограничения дозирования, коэффициенты грубых/тонких доз pH и таймаут процесса.

Команда `CONFIG_DUMP` в Serial выводит текущий снимок настроек. Любые команды, изменяющие конфигурацию (калибровка, установка скоростей, ID и пр.) автоматически обновляют структуру и вызывают `storage::save()`.

## Тестовый режим SIMULATION

При компиляции с `#define SIMULATION` подключается модуль `sim/FluidSim.*`. Он моделирует раствор с внутренним `sim_ph`, аккумулирует дозы pH-Up/Down и удобрений, симулирует плавный отклик на дозирование и подмешивает значения pH/EC/TDS напрямую в драйверы датчиков (`setSimulatedPh`, `setSimulatedSolution`). Это позволяет отлаживать весь цикл без фактического включения помп.

## Журналирование

`process/Process` отправляет на Serial события: переходы состояний (`[state]`), включения/выключения дозирующих и перемешивающих помп (`[pump]`, `[mix]`), а также подробные отчёты при авариях (`[fault]` с последними измерениями и суммарными объёмами).

## Проводка и подключения

- **Датчики:**
  - pH (PH-4502C): выход Po → A1, питание 5 V, общая земля, зонд экранирован и удалён от силовых проводов.
  - EC/TDS (Gravity Analog): OUT → A0, питание 5 V, общая земля. Температура берётся из ПК (команда `SET_T`), позже планируется DS18B20 на D4 (с подтяжкой 4.7 кΩ к +5 V).
- **LCD I²C:** модуль PCF8574 на SDA=A4 и SCL=A5, питание 5 V, адрес 0x3F (резерв 0x27).
- **Перистальтические помпы 12 V DC (pH-UP/DOWN/A/B):** управление с D7/D8/D9/D10 через MOSFET-драйверы, обязательный общий GND с Arduino, обратные диоды на моторах.
- **Помпы перемешивания 220 V AC:** SSR zero-cross (SSR-10DA/25DA) на D5/D6, силовая часть соблюдает нормы электробезопасности (УЗО, предохранитель, заземление).
- **Шумы и земля:** использовать «звездную» землю, силовые линии прокладывать отдельно, питание датчиков — стабильное +5 V (желательно через фильтр).
